# 分批创建功能说明

## 功能概述

分批创建功能是为了解决AI生成多个复杂数据模型时可能遇到的token限制问题。当用户需求涉及多个相关表时，系统会智能地将模型分批创建，确保每个批次都能成功完成。

## 工作原理

### 1. 需求分析阶段
- 用户输入业务需求描述
- AI分析需求，识别需要创建的数据模型
- 如果模型数量≤2个：直接返回完整的模型结构
- 如果模型数量>2个：返回模型清单和分批计划

### 2. 分批策略
- **优先级排序**：按业务重要性设置优先级（1=最高，2=中等，3=最低）
- **依赖检查**：确保依赖关系正确，先创建被依赖的模型
- **批次大小**：每批最多创建2个模型
- **自动继续**：当前批次完成后自动开始下一批

### 3. 创建流程
```
用户输入需求 → AI分析 → 返回响应
├── 如果≤2个模型：直接创建
└── 如果>2个模型：开始分批创建
    ├── 第一批：核心业务表（优先级1）
    ├── 第二批：关联业务表（优先级2）
    └── 第三批：扩展功能表（优先级3）
```

## 技术实现

### AI响应格式

**模型清单格式**：
```json
{
  "type": "batch_plan",
  "totalSchemas": 5,
  "schemaList": [
    {
      "name": "用户表",
      "code": "system:user",
      "description": "存储用户基本信息",
      "priority": 1,
      "dependencies": []
    },
    {
      "name": "订单表",
      "code": "order:main",
      "description": "存储订单信息",
      "priority": 2,
      "dependencies": ["system:user", "product:item"]
    }
  ]
}
```

**直接创建格式**：
```json
{
  "type": "direct",
  "schemas": [
    {
      "name": "用户表",
      "code": "system:user",
      "fields": [...],
      "keyIndexes": {...}
    }
  ]
}
```

### 状态管理

```typescript
interface BatchCreationState {
  status: 'analyzing' | 'creating' | 'completed' | 'failed';
  currentBatch: number;
  totalBatches: number;
  schemaList: SchemaInfo[];
  createdSchemas: GeneratedSchema[];
  currentBatchSchemas: GeneratedSchema[];
  dependencies: Map<string, string[]>;
}
```

### 依赖检查逻辑

```typescript
// 获取可创建的模型（依赖已满足的）
const availableSchemas = schemaList.filter(schema => {
  if (schema.status !== 'pending') return false;
  return schema.dependencies.every(dep => 
    createdSchemas.some(created => created.code === dep)
  );
});
```

## 用户界面

### 分析阶段
- 显示"正在分析您的业务需求"
- 用户可以看到AI正在分析需求

### 创建阶段
- 显示当前批次信息（第X批/共Y批）
- 显示创建进度（已创建X/共Y个模型）
- 显示当前批次正在创建的模型
- 显示所有模型的创建状态（等待中/创建中/已创建/失败）

### 完成阶段
- 显示所有已创建的模型列表
- 显示创建成功的消息
- 提供"完成"按钮

### 失败处理
- 显示失败的模型列表
- 显示失败原因
- 提供"重试"和"取消"选项

## 错误处理

### 常见错误场景
1. **AI响应解析失败**：重试当前批次
2. **依赖检查失败**：提示用户先创建依赖表
3. **创建失败**：记录失败原因，继续下一批
4. **网络错误**：自动重试，最多3次

### 错误恢复策略
- **部分失败**：记录失败的模型，继续创建成功的模型
- **批次失败**：提供重试选项，支持跳过当前批次
- **依赖失败**：提示用户先创建依赖表

## 优势

### 相比传统方案的优势
- **更智能**：AI自动分析依赖关系
- **更高效**：减少用户手动操作
- **更可靠**：自动处理依赖检查
- **更灵活**：支持暂停、重试、跳过

### 技术优势
- **Token友好**：每次只处理少量模型
- **错误隔离**：单个批次失败不影响整体
- **状态清晰**：用户可以清楚看到进度和状态

## 使用示例

### 电商系统示例
```
用户输入：需要电商系统，包含用户管理、商品管理、订单管理、库存管理等功能

AI分析结果：
- 用户表（优先级1，无依赖）
- 商品表（优先级1，无依赖）
- 订单表（优先级2，依赖用户表和商品表）
- 用户详情表（优先级2依赖用户表）
- 订单日志表（优先级3，依赖订单表）

分批创建：
- 第1批：用户表、商品表
- 第2批：订单表、用户详情表
- 第3批：订单日志表
```

### 内容管理系统示例
```
用户输入：需要内容管理系统，包含文章管理、分类管理、标签管理、用户管理等功能

AI分析结果：
- 用户表（优先级1，无依赖）
- 分类表（优先级1，无依赖）
- 文章表（优先级2，依赖用户表和分类表）
- 标签表（优先级2，无依赖）
- 文章标签关联表（优先级3，依赖文章表和标签表）

分批创建：
- 第1批：用户表、分类表
- 第2批：文章表、标签表
- 第3批：文章标签关联表
```

## 注意事项

1. **模型复杂度**：每个模型只包含核心字段（5-8个字段），避免过于复杂
2. **依赖关系**：确保模型间的依赖关系正确标注
3. **优先级设置**：按业务重要性设置优先级，确保核心表优先创建
4. **错误处理**：提供完善的错误处理和重试机制
5. **用户体验**：提供清晰的进度显示和状态反馈

## 未来优化

1. **智能分批优化**：根据模型复杂度动态调整批次大小
2. **并行创建支持**：支持无依赖关系的模型并行创建
3. **创建历史管理**：保存创建历史，支持断点续传
4. **用户自定义**：允许用户自定义分批策略
5. **性能监控**：添加创建性能监控和优化建议 