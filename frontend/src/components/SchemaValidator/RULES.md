# SchemaValidator 验证规则清单

## 概述

SchemaValidator 组件提供了一套完整的模型验证规则，用于检查数据表结构的完整性和正确性。验证规则分为两类：

- **错误 (Error)**: 必须修复的问题，会影响数据表的正常使用
- **警告 (Warning)**: 建议修复的问题，可能影响性能或最佳实践

## 验证规则详情

### 1. 主键相关规则

#### 1.1 缺少主键 (missing-primary-key)
- **类型**: 警告
- **描述**: 数据表应该设置主键字段以确保数据的唯一性和完整性
- **触发条件**: 数据表没有设置任何主键字段
- **建议**: 设置一个 UUID 或自增长 ID 字段作为主键

#### 1.2 主键允许空值 (primary-key-nullable)
- **类型**: 错误
- **描述**: 主键字段不能允许空值，这会导致数据完整性问题
- **触发条件**: 主键字段的 `required` 属性为 `false`
- **修复**: 将主键字段设置为必填

#### 1.3 主键字段类型不合适 (unsuitable-primary-key-type)
- **类型**: 警告
- **描述**: 某些字段类型不适合作为主键
- **触发条件**: 
  - 主键字段类型为以下之一：
    - `text`: 文本类型字段通常用于存储大量文本，不适合作为主键
    - `media`: 媒体类型字段用于存储文件信息，不适合作为主键
    - `api`: API类型字段用于外部数据关联，不适合作为主键
    - `date`: 日期类型字段值可能重复且不够稳定，不适合作为主键
    - `enum`: 枚举类型字段值有限且可能重复，不适合作为主键
    - `relation`: 关联类型字段不适合作为主键，建议使用关联的目标字段
    - `boolean`: 布尔类型字段只有两个可能的值，无法唯一标识记录
  - **例外情况**: 如果是联合主键且包含理想类型字段（UUID 或自增长ID），则不会触发警告

### 2. 索引相关规则

#### 2.1 唯一索引允许空值 (unique-index-nullable)
- **类型**: 错误
- **描述**: 唯一索引字段允许空值可能导致数据一致性问题
- **触发条件**: 唯一索引字段的 `required` 属性为 `false`
- **建议**: 唯一索引字段建议设置为必填，以避免空值导致的唯一性约束问题

#### 2.2 全文索引字段类型不合适 (unsuitable-fulltext-index-type)
- **类型**: 错误
- **描述**: 全文索引只适用于文本类型字段
- **触发条件**: 全文索引字段类型不是 `text` 或 `string`
- **修复**: 全文索引只适用于文本类型字段（text、string）

#### 2.3 空间索引字段类型不合适 (unsuitable-spatial-index-type)
- **类型**: 错误
- **描述**: 空间索引通常适用于存储几何数据的字段
- **触发条件**: 空间索引字段类型不是 `string`
- **修复**: 空间索引通常适用于存储几何数据的字符串字段

### 3. 字段类型验证规则

#### 3.1 枚举字段未设置目标枚举 (enum-without-target)
- **类型**: 错误
- **描述**: 枚举类型字段必须指定目标枚举对象
- **触发条件**: 
  - 枚举字段没有设置 `targetEnumCode`
  - 或指向的枚举对象不存在
- **修复**: 选择要关联的枚举对象

#### 3.2 关联字段未设置目标对象 (relation-without-target)
- **类型**: 错误
- **描述**: 关联类型字段必须指定目标数据表和关联字段
- **触发条件**:
  - 关联字段没有设置 `targetSchemaCode`
  - 或指向的目标数据表不存在
  - 或指向的目标字段不存在
- **修复**: 选择要关联的目标数据表和字段

#### 3.3 字符串字段未设置长度 (string-field-without-length)
- **类型**: 错误
- **描述**: 字符串类型字段必须设置长度限制
- **触发条件**: 字符串字段没有设置 `length` 属性
- **修复**: 字符串字段必须设置长度限制（1-255）

#### 3.4 日期字段未设置类型 (date-field-without-type)
- **类型**: 错误
- **描述**: 日期类型字段必须指定具体的日期格式
- **触发条件**: 日期字段没有设置 `dateType` 属性
- **修复**: 选择日期格式：年、年月、年月日、年月日时间

### 4. 字段命名规则

#### 4.1 字段名称重复 (duplicate-field-names)
- **类型**: 错误
- **描述**: 同一数据表中不能有重复的字段名称
- **触发条件**: 数据表中存在同名的字段
- **修复**: 修改重复的字段名称

#### 4.2 字段名称格式不正确 (invalid-field-name-format)
- **类型**: 错误
- **描述**: 字段名称必须符合命名规范
- **触发条件**: 字段名不符合正则表达式 `/^[a-z][a-z0-9_]*$/`
- **修复**: 字段名必须以小写字母开头，只能包含小写字母、数字和下划线



## 使用方式

### 基本用法

```tsx
import SchemaValidator from '@/components/SchemaValidator';

<SchemaValidator
  fields={selectedSchema?.fields ?? []}
  schemas={schemas}
  keyIndexes={selectedSchema?.keyIndexes}
  enums={enums}
  onValidationChange={(issues) => {
    console.log('Validation issues:', issues);
  }}
/>
```

### 参数说明

- `fields`: 要验证的字段数组
- `schemas`: 所有数据表列表（用于关联字段验证）
- `keyIndexes`: 当前数据表的索引配置
- `enums`: 所有枚举列表（用于枚举字段验证）
- `onValidationChange`: 验证结果变化时的回调函数

### 验证触发时机

1. **初始化时**: 组件挂载后自动执行验证
2. **字段变化时**: 当 `fields` 数组发生变化时自动重新验证
3. **索引变化时**: 当 `keyIndexes` 发生变化时自动重新验证
4. **依赖项变化时**: 当 `schemas` 或 `enums` 发生变化时自动重新验证

## 验证结果展示

### 验证通过
- 显示绿色"验证通过"标签

### 验证未通过
- 显示红色"验证未通过"标签
- 标签上显示错误和警告的数量徽章
- 鼠标悬停显示详细的问题列表
- 问题按错误和警告分组显示
- 每个问题包含详细描述和修复建议

## 扩展规则

如需添加新的验证规则，请在 `rules.ts` 文件中的 `validationRules` 数组中添加新的规则对象，格式如下：

```typescript
{
  id: 'rule-id',
  type: 'error' | 'warning',
  name: '规则名称',
  description: '规则描述',
  validator: (fields, schemas, keyIndexes, enums) => {
    // 验证逻辑
    return issues;
  }
}
``` 